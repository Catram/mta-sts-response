name: Automerge Dependabot PRs

on:
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]

jobs:
    automerge:
        runs-on: ubuntu-latest
        if: github.actor == 'dependabot[bot]'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "latest"

            - name: Install dependencies
              run: npm ci

            - name: Generate Wrangler types
              run: npx wrangler types
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

            - name: Commit updated types
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add -A
                  if ! git diff --staged --quiet; then
                      git commit -m "chore: regenerate Wrangler types after dependency update

                  This commit updates the Cloudflare Workers type definitions
                  to ensure compatibility with the latest dependency versions.
                  The types are automatically generated by 'wrangler types'
                  to reflect any changes in the Cloudflare Workers runtime API."
                      git push
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Get PR details
              id: pr
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: pullRequest } = await github.rest.pulls.get({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: context.issue.number
                      });
                      return pullRequest;

            - name: Enable auto-merge for dependabot PRs
              if: contains(steps.pr.outputs.result, '"user":{"login":"dependabot[bot]"')
              run: |
                  gh pr merge --auto --merge "${{ github.event.pull_request.number }}"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Approve dependabot PRs
              if: contains(steps.pr.outputs.result, '"user":{"login":"dependabot[bot]"')
              run: |
                  gh pr review --approve "${{ github.event.pull_request.number }}"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
