name: Dependabot auto-merge

on: pull_request

permissions:
    contents: write
    pull-requests: write

jobs:
    dependabot:
        runs-on: ubuntu-latest
        if: github.event.pull_request.user.login == 'dependabot[bot]' && github.repository == 'Catram/mta-sts-response'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "latest"

            - name: Install dependencies
              run: npm ci

            - name: Generate Wrangler types
              run: npx wrangler types
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

            - name: Commit updated types
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git add -A
                  if ! git diff --staged --quiet; then
                      git commit -m "chore: regenerate Wrangler types after dependency update

                  This commit updates the Cloudflare Workers type definitions
                  to ensure compatibility with the latest dependency versions.
                  The types are automatically generated by 'wrangler types'
                  to reflect any changes in the Cloudflare Workers runtime API."
                      git push
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Dependabot metadata
              id: metadata
              uses: dependabot/fetch-metadata@d7267f607e9d3fb96fc2fbe83e0af444713e90b7
              with:
                  github-token: "${{ secrets.GITHUB_TOKEN }}"

            - name: Enable auto-merge for Dependabot PRs
              run: gh pr merge --auto --merge "$PR_URL"
              env:
                  PR_URL: ${{ github.event.pull_request.html_url }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
